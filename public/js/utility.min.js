function ajax(a,b,c,d,e){var f=new XMLHttpRequest;f.open(a,b,!0),f.onreadystatechange=function(){4==f.readyState&&d(f)},void 0!=e&&e(f),f.send(c)}function isEmpty(a){for(var b in a)return!1;return!0}function fmt(){var a=arguments;return a[0].replace(/#{(.*?)}/g,function(b,c){return function(a,b){var c=/\d+/.test(b[0])?parseInt(b[0]):b[0];return b.length>1?arguments.callee(a[c],b.slice(1)):a[c]}("object"==typeof a[1]?a[1]:a,c.split(/\.|\[|\]\[|\]\./))})}function trim(a){return a.replace(/(^\s*)|(\s*$)/g,"")}var settings={selectMode:"mouseSelect",showPosition:"near",toggleKey:"ctrl",showTips:!0,currentWord:"",linkQuery:!1,autoAudio:!1,autoHide:!1,showDuration:3,defaultVoice:0,useHttps:!1,autoLearn:!0,apiName:"shanbay"},currentSettings=settings;chrome.storage.sync.get(null,function(a){for(var b in a)currentSettings[b]=a[b]}),chrome.storage.onChanged.addListener(function(a){void 0!==a.linkQuery&&(currentSettings.linkQuery=a.linkQuery.newValue),void 0!==a.useHttps&&(currentSettings.useHttps=a.useHttps.newValue),void 0!==a.autoAudio&&(currentSettings.autoAudio=a.autoAudio.newValue),void 0!==a.defaultVoice&&(currentSettings.defaultVoice=a.defaultVoice.newValue),void 0!==a.selectMode&&(currentSettings.selectMode=a.selectMode.newValue),void 0!==a.toggleKey&&(currentSettings.toggleKey=a.toggleKey.newValue),void 0!==a.autoHide&&(currentSettings.autoHide=a.autoHide.newValue),void 0!==a.showDuration&&(currentSettings.showDuration=a.showDuration.newValue),void 0!==a.showPosition&&(currentSettings.showPosition=a.showPosition.newValue),void 0!==a.autoLearn&&(currentSettings.autoLearn=a.autoLearn.newValue),void 0!==a.apiName&&(currentSettings.apiName=a.apiName.newValue)});var frame={titleContainer:'<div class="title-container #{3}">#{1}#{2}</div>',titleWord:'<div class="title-word">#{1}#{2}</div>',voiceContainer:'<div class="voice-container" data-src="#{1}" title="#{2}" ></div>',titleTranslation:'<div class="title-translation">#{1}</div>',basicContainer:'<div class="basic-container">#{1}#{2}</div>',phoneticContainer:'<div class="phonetic-container">#{1}#{2}</div>',ukPhoneticContainer:'<div class="uk-phonetic-container">#{1}</div>',usPhoneticContainer:'<div class="us-phonetic-container">#{1}</div>',explainsContainer:'<div class="explains-container">#{1}</div>',explainsList:'<ul class="explains-list">#{1}</ul>',explain:'<li class="explains-item">#{1}<span class="explains-item-value">#{2}</span></li>',propertyContainer:'<b class="property-container" title="#{1}">#{2}</b>',webExplainsContainer:'<div class="web-explains-container"><div class="web-title">网络释义及短语</div>#{1}</div>',webExplainsList:'<ul class="web-explains-list">#{1}</ul>',webExplain:'<li><span class="web-key">#{1}</span><span class="web-value">#{2}</span></li>'},youdao=function(){var a={key:1116151381,keyfrom:"youdaocidian"},b={dict:"http://fanyi.youdao.com/openapi.do?keyfrom="+a.keyfrom+"&key="+a.key+"&type=data&doctype=json&version=1.1&q=",voice:"http://dict.youdao.com/dictvoice?audio=",dictHttps:"https://fanyi.youdao.com/openapi.do?keyfrom="+a.keyfrom+"&key="+a.key+"&type=data&doctype=json&version=1.1&q=",voiceHttps:"https://dict.youdao.com/dictvoice?audio="},c=this;c.initVoice=function(a,b){var c="";return c=1===b?"英音":2===b?"美音":"真人发音",fmt(frame.voiceContainer,a,c)},c.checkCode=function(a){var b={message:"",error:0,Code:0};switch(a){case 0:b.Message="查询成功";break;case 20:b.Message="要翻译的文本过长",b.error=1,b.Code=20;break;case 30:b.Message="无法进行有效的翻译",b.error=1,b.Code=30;break;case 40:b.Message="不支持的语言类型",b.error=1,b.Code=40;break;case 50:b.Message="无效的key",b.error=1,b.Code=50;break;case 60:b.Message="无辞典结果",b.error=1,b.Code=60}return b},c.shortWord=function(a){return a.slice(0,a.lastIndexOf(" ",50)).concat(" ...")},c.getVoice=function(a,c){var d=(currentSettings.useHttps?b.voiceHttps:b.voice)+a.query;return void 0!==c&&(d=d+"&type="+c),d},c.initTitle=function(a){var b=a.translation,d=a.query,e=c.initVoice(c.getVoice(a));d=d.length>=50&&"select"==c.wordSource?c.shortWord(d):d;var f=fmt(frame.titleWord,d,e),g=b?fmt(frame.titleTranslation,b.toString()):"";return{titleBlock:fmt(frame.titleContainer,f,g,d.length>=50?"long-text":"")}},c.haveTranslation=function(a){if(c.checkCode(a.errorCode).error||!b)return!1;var b=a.translation,d=a.query;return trim(d.toLowerCase())===trim(b.toString().toLowerCase())?!1:!0},c.parseBasicPhonetic=function(a){var b=a.basic,d=b["uk-phonetic"],e=b["us-phonetic"];if(void 0!==d&&void 0!==e){var f=c.initVoice(c.getVoice(a,1),1),g=fmt(frame.ukPhoneticContainer,"["+d+"]"+f),h=c.initVoice(c.getVoice(a,2),2),i=fmt(frame.usPhoneticContainer,"["+e+"]"+h);return fmt(frame.phoneticContainer,g,i)}return fmt(frame.phoneticContainer,"","")},c.parseProperty=function(a){var b="";switch(a){case"adj.":b="形容词";break;case"adv.":b="副词";break;case"n.":b="名词";break;case"vi.":b="不及物动词";break;case"vt.":b="及物动词";break;case"prep.":b="介词";break;case"conj.":b="连词";break;case"int.":b="感叹词";break;case"abbr.":b="代词";break;case"pron.":b=""}return b},c.parseBasicExplains=function(a){var b,d=a.basic,e=d.explains,f="";for(b=0;b<e.length;b++){var g=e[b],h=g.indexOf(". "),i=-1!==h?g.slice(0,h+1):"",j=c.parseProperty(i),k=fmt(frame.propertyContainer,j,i),l=-1!==h?g.slice(h+1):g,m=fmt(frame.explain,k,l);f+=m}return fmt(frame.explainsContainer,fmt(frame.explainsList,f))},c.parseBasicResult=function(a){var b=c.parseBasicPhonetic(a),d=c.parseBasicExplains(a),e=fmt(frame.basicContainer,b,d);return e},c.parseWebResult=function(a){var b,c=a.web,d="";for(b=0;b<c.length;b++){var e=fmt(frame.webExplain,c[b].key,c[b].value);d+=e}return fmt(frame.webExplainsContainer,fmt(frame.webExplainsList,d))},c.parseResult=function(a){var b=c.checkCode(a.errorCode);if(b.haveWebTranslation=!1,!b.error){var d=c.initTitle(a);if(b.titleBlock=d.titleBlock,b.haveTranslation=c.haveTranslation(a),void 0!==a.basic){var e=c.parseBasicResult(a);b.basicBlock=e}if(void 0!==a.web){var f=c.parseWebResult(a);b.haveWebTranslation=!0,b.webBlock=f}}return b};var d=function(a,e,f){c.wordSource=e;var g=(currentSettings.useHttps?b.dictHttps:b.dict)+a;ajax("GET",g,null,function(b){var g=JSON.parse(b.responseText);if(-1==a.indexOf("-")||c.checkCode(g.errorCode).error||c.haveTranslation(g)){var h=c.parseResult(g);f(h)}else new d(a.replace(/-/g," "),e,f)})};c.Query=d},shanbay=function(){var a=this;a.dict="http://www.shanbay.com/api/v1/bdc/search/?word=",a.learn="http://www.shanbay.com/api/v1/bdc/learning/",a.login="http://www.shanbay.com/accounts/login/",youdao.call(this),a.getVoice=function(a,b){var c=a.basic,d=c.audio;return 1==b?d=c.uk_audio:2==b&&(d=c.us_audio),d},a.parseBasicPhonetic=function(b){var c=b.basic;if(c.pronunciations){var d=c.pronunciations.uk,e=c.pronunciations.us;if(void 0!==d&&void 0!==e){var f=a.initVoice(a.getVoice(b,1),1),g=fmt(frame.ukPhoneticContainer,"["+d+"]"+f),h=a.initVoice(a.getVoice(b,2),2),i=fmt(frame.usPhoneticContainer,"["+e+"]"+h);return fmt(frame.phoneticContainer,g,i)}}var h=a.initVoice(a.getVoice(b)),j=fmt(frame.usPhoneticContainer,"["+c.phonetic+"]"+h);return fmt(frame.phoneticContainer,j,"")},a.parseBasicExplains=function(b){var c,d=b.basic,e=d.definition,f="",g=e.split("\n");for(c=0;c<g.length;c++){var h=g[c],i=h.indexOf("."),j=-1!==i?h.slice(0,i+1):"",k=a.parseProperty(j),l=fmt(frame.propertyContainer,k,j),m=-1!==i?h.slice(i+1):h,n=fmt(frame.explain,l,m);f+=n}return fmt(frame.explainsContainer,fmt(frame.explainsList,f))},a.Query=function(b,c,d){var e=a.dict+b;ajax("GET",e,null,function(e){var f=JSON.parse(e.responseText),g=f.data;if(0==f.status_code){g={basic:{pronunciations:g.pronunciations,phonetic:g.pron,audio:g.audio,us_audio:g.us_audio,uk_audio:g.uk_audio,cn_definition:g.cn_definition,en_definition:g.en_definition,definition:g.definition},query:g.content,errorCode:0};var h=a.parseResult(g);d(h),g={id:f.data.id,content_type:"vocabulary"},currentSettings.autoLearn&&ajax("POST",a.learn,JSON.stringify(g),function(b){var c=JSON.parse(b.responseText);401==b.status&&(confirm(c.msg+"\n你选择了自动加入生词本,但你没有登陆扇贝网或登陆已失效，是否现在登陆?")?chrome.tabs.create({url:a.login}):currentSettings.autoLearn=!1)},function(a){a.setRequestHeader("Content-Type","application/json")})}else if(1==f.status_code){var i=new youdao;i.Query(b,c,d)}})}},xyuu=function(){shanbay.call(this),this.dict="http://dict.xyuu.com.cn/search/?word="},api={youdao:youdao,shanbay:shanbay,xyuu:xyuu};